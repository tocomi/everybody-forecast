<div>
  <div class="horse-list-header jumbotron">
    <p class="header-race-number"><%= @race_detail[:race_number] %></p>
    <p class="header-race-name"><%= @race_detail[:race_name] %></p>
    <%= link_to 'netkeiba', "http://race.netkeiba.com#{params[:target]}", class: 'btn btn-primary header-netkeiba-link', :target=>["_blank"] %>
  </div>
  <table class="table table-bordered table-hover table-striped">
    <thead>
      <tr>
        <th class="header align-center">枠</th>
        <th class="header align-center">番</th>
        <th class="header align-center">馬名</th>
        <th class="header align-center">性</th>
        <th class="header align-center">齢</th>
        <th class="header align-center">斤</th>
        <th class="header align-center">騎手</th>
        <th class="header align-center">率</th>
        <th class="header align-center">人</th>
        <% if user_signed_in? %>
          <th class="header align-center">予想</th>
        <% end %>
        <% @other_users.each do |user| %>
          <th class="header align-center"><%= truncate(user[:display_name], :length => 3, :omission => '') %></th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% forecast_select = { "-" => 0, "◎" => 1, "○" => 2, "▲" => 3, "△" => 4, "☆" => 5 } %>
      <% forecast_mark = { 1 => "◎", 2 => "○", 3 => "▲", 4 => "△", 5 => "☆" } %>
      <% @horse_list.each do |horse| %>
        <tr>
          <td class="<%= horse.get_gate_class %>"><%= "#{horse.gate_number}" %></td>
          <td class="horse-table horse-number text-upright background-white"><%= "#{horse.horse_number}" %></td>
          <td class="horse-table horse-name"><%= "#{horse.name}" %></td>
          <td class="<%= horse.get_sex_class %>"><%= "#{horse.sex}" %></td>
          <td class="horse-table horse-age text-upright"><%= "#{horse.age}" %></td>
          <td class="horse-table horse-handi text-upright"><%= "#{horse.handi}" %></td>
          <td class="horse-table horse-jockey"><%= "#{horse.jockey}" %></td>
          <td class="horse-table horse-odds text-upright"><%= "#{horse.odds}" %></td>
          <td class="horse-table horse-rank text-upright"><%= "#{horse.rank}" %></td>

          <% if user_signed_in? %>
            <td class="horse-table forecast">
              <% if horse.gate_number.empty? then %>
                <% return %>
              <% end %>
              <% @exists_forecast = false %>
              <% @my_forecasts.each do |forecast| %>
                <% if forecast[:horse_number].to_i == horse.horse_number.to_i then %>
                  <%= select :forecast, :key, forecast_select, :selected => forecast[:forecast], class: 'select-mark' %>
                  <% @exists_forecast = true %>
                <% end %>
              <% end %>
              <% if @exists_forecast == false %>
                <%= select :forecast, :key, forecast_select, class: 'select-mark' %>
              <% end %>
            </td>
          <% end %>

          <% @other_users.each do |other_user| %>
            <% other_forecasts = @other_forecasts.where("user_id = ?", other_user.user_id) %>
            <td class="horse-table forecast">
              <% other_forecasts.each do |other_forecast| %>
                <% if other_forecast[:horse_number].to_i == horse.horse_number.to_i then %>
                  <%= forecast_mark[other_forecast[:forecast]] %>
                <% end %>
              <% end %>
            </td>
          <% end %>
          
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
